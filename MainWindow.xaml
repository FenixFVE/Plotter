<Window x:Class="WpfPlotApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:scottplot="clr-namespace:ScottPlot.WPF;assembly=ScottPlot.WPF"
        xmlns:converters="clr-namespace:WpfPlotApp.Converters"
        xmlns:controls="clr-namespace:WpfPlotApp.Controls"
        xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
        Title="Редактор Графиков" 
        Height="600" 
        Width="1000"
        WindowStartupLocation="CenterScreen">
    
    <Window.Resources>
        <converters:MarkerShapeConverter x:Key="MarkerShapeConverter"/>
        <converters:ColorConverter x:Key="ColorConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:MultipleSelectionToVisibilityConverter x:Key="MultipleSelectionToVisibilityConverter"/>
        <converters:PrecisionConverter x:Key="PrecisionConverter"/>
        <converters:PointOrderConverter x:Key="PointOrderConverter"/>
        <converters:FunctionOrderConverter x:Key="FunctionOrderConverter"/>
        <converters:BooleanInverterConverter x:Key="BooleanInverterConverter"/>
        
        <!-- Стиль для затемненных отключенных полей -->
        <Style x:Key="DisabledTextBoxStyle" TargetType="controls:PrecisionTextBox">
            <Style.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Background" Value="#F0F0F0"/>
                    <Setter Property="Foreground" Value="#808080"/>
                    <Setter Property="BorderBrush" Value="#D0D0D0"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Стиль для обычных TextBox -->
        <Style x:Key="DisabledRegularTextBoxStyle" TargetType="TextBox">
            <Style.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Background" Value="#F0F0F0"/>
                    <Setter Property="Foreground" Value="#808080"/>
                    <Setter Property="BorderBrush" Value="#D0D0D0"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>
    
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="2*"/>
            <ColumnDefinition Width="5"/>
            <ColumnDefinition Width="1*"/>
        </Grid.ColumnDefinitions>

        <!-- Область графика -->
        <Border Grid.Column="0" 
                BorderBrush="Gray" 
                BorderThickness="1"
                Margin="10">
            <scottplot:WpfPlot x:Name="PlotControl"/>
        </Border>

        <!-- Разделитель -->
        <GridSplitter Grid.Column="1" 
                      Width="5"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch"
                      Background="LightGray"/>

        <!-- Панель управления -->
        <Grid Grid.Column="2" 
              Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- Панель управления точками -->
            <DockPanel Grid.Row="0">
            


            <!-- Информация о курсоре -->
            <Border DockPanel.Dock="Top" 
                    BorderBrush="LightGray"
                    BorderThickness="1"
                    Padding="5"
                    Margin="0,0,0,10">
                <TextBlock x:Name="CursorInfoTextBlock"
                           Text="Курсор: X=0.00, Y=0.00"
                           FontSize="12"
                           HorizontalAlignment="Center"/>
            </Border>



            <!-- Управление масштабом -->
            <Border DockPanel.Dock="Top" 
                    BorderBrush="DarkGray"
                    BorderThickness="1"
                    Padding="8"
                    Margin="0,0,0,10">
                <StackPanel>
                    <TextBlock Text="Масштаб графика"
                               FontSize="12"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"
                               Margin="0,0,0,8"/>
                    
                    <!-- Настройка точности -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" 
                                   Text="Точность (знаков после запятой):"
                                   VerticalAlignment="Center"
                                   Margin="0,0,5,0"/>
                        <TextBox Grid.Column="1"
                                 Text="{Binding Precision, UpdateSourceTrigger=PropertyChanged}"
                                 TextChanged="PrecisionTextBox_TextChanged"
                                 HorizontalAlignment="Left"
                                 Width="50"/>
                    </Grid>
                    
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- X ось -->
                        <TextBlock Grid.Row="0" Grid.Column="0" 
                                   Text="X min:" 
                                   VerticalAlignment="Center" 
                                   Margin="0,0,5,5"/>
                        <controls:PrecisionTextBox Grid.Row="0" Grid.Column="1" 
                                                           x:Name="MinXTextBox"
                                                           NumericValue="{Binding MinX}"
                                                           Precision="{Binding Precision}"
                                                           TextChanged="AxisLimitTextBox_TextChanged"
                                                           Tag="MinX"
                                                           IsEnabled="{Binding LockX, Converter={StaticResource BooleanInverterConverter}}"
                                                           Style="{StaticResource DisabledTextBoxStyle}"
                                                           Margin="0,0,10,5"/>
                        
                        <TextBlock Grid.Row="0" Grid.Column="2" 
                                   Text="X max:" 
                                   VerticalAlignment="Center" 
                                   Margin="0,0,5,5"/>
                        <controls:PrecisionTextBox Grid.Row="0" Grid.Column="3" 
                                                   x:Name="MaxXTextBox"
                                                   NumericValue="{Binding MaxX}"
                                                   Precision="{Binding Precision}"
                                                   TextChanged="AxisLimitTextBox_TextChanged"
                                                   Tag="MaxX"
                                                   IsEnabled="{Binding LockX, Converter={StaticResource BooleanInverterConverter}}"
                                                   Style="{StaticResource DisabledTextBoxStyle}"
                                                   Margin="0,0,0,5"/>

                        <!-- Y ось -->
                        <TextBlock Grid.Row="1" Grid.Column="0" 
                                   Text="Y min:" 
                                   VerticalAlignment="Center" 
                                   Margin="0,0,5,5"/>
                        <controls:PrecisionTextBox Grid.Row="1" Grid.Column="1" 
                                                   x:Name="MinYTextBox"
                                                   NumericValue="{Binding MinY}"
                                                   Precision="{Binding Precision}"
                                                   TextChanged="AxisLimitTextBox_TextChanged"
                                                   Tag="MinY"
                                                   IsEnabled="{Binding LockY, Converter={StaticResource BooleanInverterConverter}}"
                                                   Style="{StaticResource DisabledTextBoxStyle}"
                                                   Margin="0,0,10,5"/>
                        
                        <TextBlock Grid.Row="1" Grid.Column="2" 
                                   Text="Y max:" 
                                   VerticalAlignment="Center" 
                                   Margin="0,0,5,5"/>
                        <controls:PrecisionTextBox Grid.Row="1" Grid.Column="3" 
                                                   x:Name="MaxYTextBox"
                                                   NumericValue="{Binding MaxY}"
                                                   Precision="{Binding Precision}"
                                                   TextChanged="AxisLimitTextBox_TextChanged"
                                                   Tag="MaxY"
                                                   IsEnabled="{Binding LockY, Converter={StaticResource BooleanInverterConverter}}"
                                                   Style="{StaticResource DisabledTextBoxStyle}"
                                                   Margin="0,0,0,5"/>

                        <!-- Блокировки осей -->
                        <CheckBox Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" 
                                  IsChecked="{Binding LockX}" 
                                  Content="🔒 Блокировать X" 
                                  ToolTip="Заблокировать перемещение и масштабирование по оси X"
                                  Margin="0,5,10,0"
                                  Checked="AxisLockCheckBox_Changed"
                                  Unchecked="AxisLockCheckBox_Changed"/>
                        
                        <CheckBox Grid.Row="2" Grid.Column="2" Grid.ColumnSpan="2" 
                                  IsChecked="{Binding LockY}" 
                                  Content="🔒 Блокировать Y" 
                                  ToolTip="Заблокировать перемещение и масштабирование по оси Y"
                                  Margin="0,5,0,0"
                                  Checked="AxisLockCheckBox_Changed"
                                  Unchecked="AxisLockCheckBox_Changed"/>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Кнопки сохранения и загрузки -->
            <StackPanel DockPanel.Dock="Top" 
                        Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,10">
                <Button x:Name="SaveProjectButton"
                        Content="💾 Сохранить"
                        Click="SaveProjectButton_Click"
                        Margin="0,0,5,0"
                        Padding="10,5"
                        ToolTip="Сохранить проект в JSON файл"/>
                <Button x:Name="LoadProjectButton"
                        Content="📁 Загрузить"
                        Click="LoadProjectButton_Click"
                        Margin="0,0,5,0"
                        Padding="10,5"
                        ToolTip="Загрузить проект из JSON файла"/>
                <Button x:Name="NewProjectButton"
                        Content="📄 Новый"
                        Click="NewProjectButton_Click"
                        Padding="10,5"
                        ToolTip="Создать новый проект (очистить всё)"/>
            </StackPanel>

            <!-- Заголовок для точек -->
            <TextBlock DockPanel.Dock="Top" 
                       Text="Управление точками"
                       FontSize="16"
                       FontWeight="Bold"
                       Margin="0,0,0,5"
                       HorizontalAlignment="Center"/>

            <!-- Информация о выборе -->
            <Border DockPanel.Dock="Top" 
                    BorderBrush="LightBlue"
                    BorderThickness="1"
                    Padding="5"
                    Margin="0,0,0,10"
                    Visibility="{Binding HasSelectedPoints, Converter={StaticResource BooleanToVisibilityConverter}}">
                <TextBlock Text="{Binding SelectedPointsCount, StringFormat='Выбрано точек: {0}'}"
                           FontSize="12"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="Blue"/>
            </Border>

            <!-- Кнопки -->
            <StackPanel DockPanel.Dock="Top" 
                        Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,10">
                <Button x:Name="AddPointButton"
                        Content="Добавить точку"
                        Click="AddPointButton_Click"
                        Margin="0,0,5,0"
                        Padding="10,5"/>
                <Button x:Name="RemovePointButton"
                        Content="Удалить выбранные"
                        Click="RemoveSelectedPointsButton_Click"
                        Margin="0,0,5,0"
                        Padding="10,5"
                        IsEnabled="{Binding HasSelectedPoints}"/>
                <Button x:Name="RecalculateExpressionsButton"
                        Content="🔄 Пересчитать всё"
                        Click="RecalculateExpressionsButton_Click"
                        Padding="10,5"
                        ToolTip="Принудительно пересчитать все выражения и функции"/>
            </StackPanel>

            <!-- Список точек -->
            <Border BorderBrush="Gray" 
                    BorderThickness="1">
                <ListBox x:Name="PointsListBox"
                         ItemsSource="{Binding Points}" 
                         SelectedItem="{Binding SelectedPoint}"
                         SelectionMode="Extended"
                         Background="White"
                         SelectionChanged="PointsListBox_SelectionChanged">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border BorderBrush="LightGray" 
                                    BorderThickness="0,0,0,1" 
                                    Padding="5"
                                    Margin="0,0,0,2">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Кнопки перемещения точек -->
                                    <StackPanel Grid.Column="0" 
                                                Orientation="Vertical"
                                                VerticalAlignment="Center"
                                                Margin="0,0,5,0">
                                        <Button Content="▲"
                                                Click="MovePointUpButton_Click"
                                                Width="20"
                                                Height="20"
                                                Margin="0,0,0,2"
                                                FontSize="10"
                                                ToolTip="Переместить вверх (недоступно при групповом выделении)">
                                            <Button.IsEnabled>
                                                <MultiBinding Converter="{StaticResource PointOrderConverter}" ConverterParameter="Up">
                                                    <Binding Path="."/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.Points"/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.SelectedPointsCount"/>
                                                </MultiBinding>
                                            </Button.IsEnabled>
                                        </Button>
                                        <Button Content="▼"
                                                Click="MovePointDownButton_Click"
                                                Width="20"
                                                Height="20"
                                                FontSize="10"
                                                ToolTip="Переместить вниз (недоступно при групповом выделении)">
                                            <Button.IsEnabled>
                                                <MultiBinding Converter="{StaticResource PointOrderConverter}" ConverterParameter="Down">
                                                    <Binding Path="."/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.Points"/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.SelectedPointsCount"/>
                                                </MultiBinding>
                                            </Button.IsEnabled>
                                        </Button>
                                    </StackPanel>
                                    
                                    <Expander Grid.Column="1"
                                              IsExpanded="{Binding IsExpanded}"
                                              Header="{Binding Name, Converter={StaticResource PointNameDisplayConverter}}"
                                              Margin="0">
                                        <Expander.Content>
                                    <StackPanel Margin="10,5,0,5">
                                        <!-- Индикатор группового редактирования -->
                                        <TextBlock Text="🔗 Групповое редактирование активно"
                                                   FontSize="10"
                                                   FontStyle="Italic"
                                                   Foreground="Blue"
                                                   HorizontalAlignment="Center"
                                                   Margin="0,0,0,5">
                                            <TextBlock.Visibility>
                                                <MultiBinding Converter="{StaticResource MultipleSelectionToVisibilityConverter}">
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.SelectedPointsCount"/>
                                                    <Binding Path="."/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="SelectedItems"/>
                                                </MultiBinding>
                                            </TextBlock.Visibility>
                                        </TextBlock>
                                        
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="120"/>
                                                <ColumnDefinition Width="120"/>
                                            </Grid.ColumnDefinitions>

                                            <!-- Название точки -->
                                            <CheckBox Grid.Row="0" 
                                                      Grid.Column="0"
                                                      IsChecked="{Binding LockName}"
                                                      ToolTip="Заблокировать название"
                                                      VerticalAlignment="Center"
                                                      Content="🔒"
                                                      Margin="0,0,5,5"/>
                                            <TextBlock Grid.Row="0" 
                                                       Grid.Column="1"
                                                       Text="Название:"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,5,5"/>
                                            <TextBox Grid.Row="0" 
                                                     Grid.Column="2"
                                                     Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                                     TextChanged="NameTextBox_TextChanged"
                                                     IsEnabled="{Binding LockName, Converter={StaticResource BooleanInverterConverter}}"
                                                     Style="{StaticResource DisabledRegularTextBoxStyle}"
                                                     ToolTip="Имя точки (только буквы, например: A, B, AA, AB)"
                                                     Margin="0,0,0,5"/>

                                            <!-- X координата -->
                                            <CheckBox Grid.Row="1" 
                                                      Grid.Column="0"
                                                      IsChecked="{Binding LockX}"
                                                      ToolTip="Заблокировать X координату"
                                                      VerticalAlignment="Center"
                                                      Content="🔒"
                                                      Margin="0,0,5,5"/>
                                            <TextBlock Grid.Row="1" 
                                                       Grid.Column="1"
                                                       Text="X:"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,5,5"/>
                                            <controls:PrecisionTextBox Grid.Row="1" 
                                                                       Grid.Column="2"
                                                                       NumericValue="{Binding X}"
                                                                       Precision="{Binding DataContext.Precision, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                       TextChanged="XTextBox_TextChanged"
                                                                       IsEnabled="{Binding LockX, Converter={StaticResource BooleanInverterConverter}}"
                                                                       Style="{StaticResource DisabledTextBoxStyle}"
                                                                       Margin="0,0,5,5"/>
                                            <TextBox Grid.Row="1" 
                                                     Grid.Column="3"
                                                     Name="XExpressionTextBox"
                                                     Text="{Binding XExpression, UpdateSourceTrigger=PropertyChanged}"
                                                     TextChanged="XExpressionTextBox_TextChanged"
                                                     ToolTip="Выражение для X (например: B.X, C.Y)"
                                                     Margin="0,0,0,5"/>

                                            <!-- Y координата -->
                                            <CheckBox Grid.Row="2" 
                                                      Grid.Column="0"
                                                      IsChecked="{Binding LockY}"
                                                      ToolTip="Заблокировать Y координату"
                                                      VerticalAlignment="Center"
                                                      Content="🔒"
                                                      Margin="0,0,5,5"/>
                                            <TextBlock Grid.Row="2" 
                                                       Grid.Column="1"
                                                       Text="Y:"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,5,5"/>
                                            <controls:PrecisionTextBox Grid.Row="2" 
                                                                       Grid.Column="2"
                                                                       NumericValue="{Binding Y}"
                                                                       Precision="{Binding DataContext.Precision, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                       TextChanged="YTextBox_TextChanged"
                                                                       IsEnabled="{Binding LockY, Converter={StaticResource BooleanInverterConverter}}"
                                                                       Style="{StaticResource DisabledTextBoxStyle}"
                                                                       Margin="0,0,5,5"/>
                                            <TextBox Grid.Row="2" 
                                                     Grid.Column="3"
                                                     Name="YExpressionTextBox"
                                                     Text="{Binding YExpression, UpdateSourceTrigger=PropertyChanged}"
                                                     TextChanged="YExpressionTextBox_TextChanged"
                                                     ToolTip="Выражение для Y (например: A.Y, B.X)"
                                                     Margin="0,0,0,5"/>

                                            <!-- Размер -->
                                            <CheckBox Grid.Row="3" 
                                                      Grid.Column="0"
                                                      IsChecked="{Binding LockSize}"
                                                      ToolTip="Заблокировать размер"
                                                      VerticalAlignment="Center"
                                                      Content="🔒"
                                                      Margin="0,0,5,5"/>
                                            <TextBlock Grid.Row="3" 
                                                       Grid.Column="1"
                                                       Text="Размер:"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,5,5"/>
                                            <TextBox Grid.Row="3" 
                                                     Grid.Column="2"
                                                     Text="{Binding MarkerSize, UpdateSourceTrigger=PropertyChanged}" 
                                                     TextChanged="SizeTextBox_TextChanged"
                                                     IsEnabled="{Binding LockSize, Converter={StaticResource BooleanInverterConverter}}"
                                                     Style="{StaticResource DisabledRegularTextBoxStyle}"
                                                     Margin="0,0,0,5"/>

                                            <!-- Форма -->
                                            <CheckBox Grid.Row="4" 
                                                      Grid.Column="0"
                                                      IsChecked="{Binding LockShape}"
                                                      ToolTip="Заблокировать форму"
                                                      VerticalAlignment="Center"
                                                      Content="🔒"
                                                      Margin="0,0,5,5"/>
                                            <TextBlock Grid.Row="4" 
                                                       Grid.Column="1"
                                                       Text="Форма:"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,5,5"/>
                                            <ComboBox Grid.Row="4" 
                                                      Grid.Column="2"
                                                      SelectedValue="{Binding MarkerShape, Converter={StaticResource MarkerShapeConverter}}"
                                                      SelectedValuePath="Tag"
                                                      SelectionChanged="ShapeComboBox_SelectionChanged"
                                                      IsEnabled="{Binding LockShape, Converter={StaticResource BooleanInverterConverter}}"
                                                      Margin="0,0,0,5">
                                                <ComboBoxItem Content="Круг" Tag="FilledCircle"/>
                                                <ComboBoxItem Content="Квадрат" Tag="FilledSquare"/>
                                                <ComboBoxItem Content="Ромб" Tag="FilledDiamond"/>
                                                <ComboBoxItem Content="Пустой круг" Tag="OpenCircle"/>
                                                <ComboBoxItem Content="Пустой квадрат" Tag="OpenSquare"/>
                                            </ComboBox>

                                            <!-- Цвет -->
                                            <CheckBox Grid.Row="5" 
                                                      Grid.Column="0"
                                                      IsChecked="{Binding LockColor}"
                                                      ToolTip="Заблокировать цвет"
                                                      VerticalAlignment="Center"
                                                      Content="🔒"
                                                      Margin="0,0,5,5"/>
                                            <TextBlock Grid.Row="5" 
                                                       Grid.Column="1"
                                                       Text="Цвет:"
                                                       VerticalAlignment="Center"
                                                       Margin="0,0,5,5"/>
                                            <xctk:ColorPicker Grid.Row="5" 
                                                              Grid.Column="2"
                                                              SelectedColor="{Binding Color, Converter={StaticResource ColorConverter}}"
                                                              DisplayColorAndName="True"
                                                              ShowRecentColors="True" 
                                                              ShowStandardColors="True"
                                                              ShowAvailableColors="True"
                                                              ShowDropDownButton="True"
                                                              ColorMode="ColorPalette"
                                                              UsingAlphaChannel="True"
                                                              SelectedColorChanged="ColorPicker_SelectedColorChanged"
                                                              IsEnabled="{Binding LockColor, Converter={StaticResource BooleanInverterConverter}}"
                                                              Width="150"
                                                              Height="25"/>
                                        </Grid>
                                    </StackPanel>
                                        </Expander.Content>
                                    </Expander>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Border>
            
            </DockPanel>
            
            <!-- Панель управления функциями -->
            <!-- Разделитель между секциями -->
            <GridSplitter Grid.Row="1"
                         Height="8"
                         Background="LightGray"
                         HorizontalAlignment="Stretch"
                         VerticalAlignment="Center"
                         ShowsPreview="True"
                         Cursor="SizeNS"/>
            
            <DockPanel Grid.Row="2">
            
            <!-- Заголовок для функций -->
            <TextBlock DockPanel.Dock="Top" 
                       Text="Управление функциями"
                       FontSize="16"
                       FontWeight="Bold"
                       Margin="0,20,0,10"
                       HorizontalAlignment="Center"/>

            <!-- Информация о выборе функций -->
            <Border DockPanel.Dock="Top" 
                    BorderBrush="LightGreen"
                    BorderThickness="1"
                    Padding="5"
                    Margin="0,0,0,10"
                    Visibility="{Binding HasSelectedFunctions, Converter={StaticResource BooleanToVisibilityConverter}}">
                <TextBlock Text="{Binding SelectedFunctionsCount, StringFormat='Выбрано функций: {0}'}"
                           FontSize="12"
                           FontWeight="Bold"
                           HorizontalAlignment="Center"
                           Foreground="Green"/>
            </Border>

            <!-- Кнопки управления функциями -->
            <StackPanel DockPanel.Dock="Top" 
                        Orientation="Horizontal"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,10">
                <Button x:Name="AddFunctionButton"
                        Content="Добавить функцию"
                        Click="AddFunctionButton_Click"
                        Margin="0,0,5,0"
                        Padding="10,5"/>
                <Button x:Name="RemoveFunctionButton"
                        Content="Удалить выбранные"
                        Click="RemoveSelectedFunctionsButton_Click"
                        Margin="0,0,5,0"
                        Padding="10,5"
                        IsEnabled="{Binding HasSelectedFunctions}"/>
            </StackPanel>

            <!-- Список функций -->
            <Border BorderBrush="Gray" 
                    BorderThickness="1">
                <ListBox x:Name="FunctionsListBox"
                         ItemsSource="{Binding Functions}" 
                         SelectedItem="{Binding SelectedFunction}"
                         SelectionMode="Extended"
                         Background="White"
                         SelectionChanged="FunctionsListBox_SelectionChanged">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border BorderBrush="LightGray" 
                                    BorderThickness="0,0,0,1" 
                                    Padding="5"
                                    Margin="0,0,0,2">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Кнопки перемещения функций -->
                                    <StackPanel Grid.Column="0" 
                                                Orientation="Vertical"
                                                VerticalAlignment="Center"
                                                Margin="0,0,5,0">
                                        <Button Content="▲"
                                                Click="MoveFunctionUpButton_Click"
                                                Width="20"
                                                Height="20"
                                                Margin="0,0,0,2"
                                                FontSize="10"
                                                ToolTip="Переместить вверх (недоступно при групповом выделении)">
                                            <Button.IsEnabled>
                                                <MultiBinding Converter="{StaticResource FunctionOrderConverter}" ConverterParameter="Up">
                                                    <Binding Path="."/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.Functions"/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.SelectedFunctionsCount"/>
                                                </MultiBinding>
                                            </Button.IsEnabled>
                                        </Button>
                                        <Button Content="▼"
                                                Click="MoveFunctionDownButton_Click"
                                                Width="20"
                                                Height="20"
                                                FontSize="10"
                                                ToolTip="Переместить вниз (недоступно при групповом выделении)">
                                            <Button.IsEnabled>
                                                <MultiBinding Converter="{StaticResource FunctionOrderConverter}" ConverterParameter="Down">
                                                    <Binding Path="."/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.Functions"/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.SelectedFunctionsCount"/>
                                                </MultiBinding>
                                            </Button.IsEnabled>
                                        </Button>
                                    </StackPanel>
                                    
                                    <Expander Grid.Column="1"
                                              IsExpanded="{Binding IsExpanded}"
                                              Header="{Binding Name}"
                                              Margin="0">
                                        <Expander.Content>
                                            <StackPanel Margin="10,5,0,5">
                                                <!-- Индикатор группового редактирования -->
                                                <TextBlock Text="🔗 Групповое редактирование активно"
                                                           FontSize="10"
                                                           FontStyle="Italic"
                                                           Foreground="Blue"
                                                           HorizontalAlignment="Center"
                                                           Margin="0,0,0,5">
                                                    <TextBlock.Visibility>
                                                        <MultiBinding Converter="{StaticResource MultipleSelectionToVisibilityConverter}">
                                                            <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="DataContext.SelectedFunctionsCount"/>
                                                            <Binding Path="."/>
                                                            <Binding RelativeSource="{RelativeSource AncestorType=ListBox}" Path="SelectedItems"/>
                                                        </MultiBinding>
                                                    </TextBlock.Visibility>
                                                </TextBlock>
                                                
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="200"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Название функции -->
                                                    <CheckBox Grid.Row="0" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockName}"
                                                              ToolTip="Заблокировать название"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="0" 
                                                               Grid.Column="1"
                                                               Text="Название:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="0" 
                                                             Grid.Column="2"
                                                             Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionNameTextBox_TextChanged"
                                                             IsEnabled="{Binding LockName, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Имя функции (например: f1, f2, g)"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Выражение функции -->
                                                    <CheckBox Grid.Row="1" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockExpression}"
                                                              ToolTip="Заблокировать выражение"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="1" 
                                                               Grid.Column="1"
                                                               Text="Выражение:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="1" 
                                                             Grid.Column="2"
                                                             Text="{Binding Expression, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionExpressionTextBox_TextChanged"
                                                             IsEnabled="{Binding LockExpression, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Математическое выражение (например: sin(x), x^2, A.X + x)"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Отображение -->
                                                    <CheckBox Grid.Row="2" 
                                                              Grid.Column="1"
                                                              Grid.ColumnSpan="2"
                                                              IsChecked="{Binding IsVisible}"
                                                              Content="Отображать на графике"
                                                              ToolTip="Показывать/скрывать функцию на графике"
                                                              Margin="0,0,0,5"/>

                                                    <!-- Min X -->
                                                    <CheckBox Grid.Row="3" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockMinX}"
                                                              ToolTip="Заблокировать минимум X"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="3" 
                                                               Grid.Column="1"
                                                               Text="Min X:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="3" 
                                                             Grid.Column="2"
                                                             Text="{Binding MinX, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionMinXTextBox_TextChanged"
                                                             IsEnabled="{Binding LockMinX, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Минимальное значение X для отрисовки"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Max X -->
                                                    <CheckBox Grid.Row="4" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockMaxX}"
                                                              ToolTip="Заблокировать максимум X"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="4" 
                                                               Grid.Column="1"
                                                               Text="Max X:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="4" 
                                                             Grid.Column="2"
                                                             Text="{Binding MaxX, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionMaxXTextBox_TextChanged"
                                                             IsEnabled="{Binding LockMaxX, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Максимальное значение X для отрисовки"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Автомасштабирование -->
                                                    <CheckBox Grid.Row="5" 
                                                              Grid.Column="1"
                                                              Grid.ColumnSpan="2"
                                                              IsChecked="{Binding AutoScale}"
                                                              Content="Автомасштабирование X"
                                                              ToolTip="Использовать масштаб экрана для диапазона X"
                                                              Margin="0,0,0,5"/>

                                                    <!-- Min Y -->
                                                    <CheckBox Grid.Row="6" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockMinY}"
                                                              ToolTip="Заблокировать минимум Y"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="6" 
                                                               Grid.Column="1"
                                                               Text="Min Y:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="6" 
                                                             Grid.Column="2"
                                                             Text="{Binding MinY, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionMinYTextBox_TextChanged"
                                                             IsEnabled="{Binding LockMinY, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Минимальное значение Y для неявных кривых"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Max Y -->
                                                    <CheckBox Grid.Row="7" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockMaxY}"
                                                              ToolTip="Заблокировать максимум Y"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="7" 
                                                               Grid.Column="1"
                                                               Text="Max Y:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="7" 
                                                             Grid.Column="2"
                                                             Text="{Binding MaxY, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionMaxYTextBox_TextChanged"
                                                             IsEnabled="{Binding LockMaxY, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Максимальное значение Y для неявных кривых"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Количество аргументов -->
                                                    <CheckBox Grid.Row="8" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockArgumentCount}"
                                                              ToolTip="Заблокировать количество аргументов"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="8" 
                                                               Grid.Column="1"
                                                               Text="Аргументы:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="8" 
                                                             Grid.Column="2"
                                                             Text="{Binding ArgumentCount, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionArgumentCountTextBox_TextChanged"
                                                             IsEnabled="{Binding LockArgumentCount, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Количество аргументов функции (1-5)"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Имена аргументов -->
                                                    <CheckBox Grid.Row="9" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockArgumentNames}"
                                                              ToolTip="Заблокировать имена аргументов"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="9" 
                                                               Grid.Column="1"
                                                               Text="Имена аргументов:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="9" 
                                                             Grid.Column="2"
                                                             Text="{Binding ArgumentNames, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionArgumentNamesTextBox_TextChanged"
                                                             IsEnabled="{Binding LockArgumentNames, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Имена аргументов через запятую (например: x,y,z)"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Неявная кривая -->
                                                    <CheckBox Grid.Row="10" 
                                                              Grid.Column="1"
                                                              Grid.ColumnSpan="2"
                                                              IsChecked="{Binding IsImplicitCurve}"
                                                              Content="Неявная кривая"
                                                              ToolTip="Использовать для неявных кривых (например: x^2 + y^2 = 1)"
                                                              Margin="0,0,0,5"
                                                              Checked="FunctionIsImplicitCurveCheckBox_Changed"
                                                              Unchecked="FunctionIsImplicitCurveCheckBox_Changed"/>

                                                    <!-- Режим производительности -->
                                                    <CheckBox Grid.Row="11" 
                                                              Grid.Column="1"
                                                              Grid.ColumnSpan="2"
                                                              IsChecked="{Binding PerformanceMode}"
                                                              Content="⚡ Режим производительности"
                                                              ToolTip="Быстрая отрисовка неявных кривых с низким качеством"
                                                              Margin="0,0,0,5"
                                                              IsEnabled="{Binding IsImplicitCurve}"
                                                              Checked="FunctionPerformanceModeCheckBox_Changed"
                                                              Unchecked="FunctionPerformanceModeCheckBox_Changed"/>

                                                    <!-- Цвет линии -->
                                                    <CheckBox Grid.Row="12" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockColor}"
                                                              ToolTip="Заблокировать цвет"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="12" 
                                                               Grid.Column="1"
                                                               Text="Цвет:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <xctk:ColorPicker Grid.Row="12" 
                                                                      Grid.Column="2"
                                                                      SelectedColor="{Binding Color, Converter={StaticResource ColorConverter}}"
                                                                      DisplayColorAndName="True"
                                                                      ShowRecentColors="True" 
                                                                      ShowStandardColors="True"
                                                                      ShowAvailableColors="True"
                                                                      ShowDropDownButton="True"
                                                                      ColorMode="ColorPalette"
                                                                      UsingAlphaChannel="True"
                                                                      SelectedColorChanged="FunctionColorPicker_SelectedColorChanged"
                                                                      IsEnabled="{Binding LockColor, Converter={StaticResource BooleanInverterConverter}}"
                                                                      Width="120"
                                                                      Height="25"
                                                                      Margin="0,0,0,5"/>

                                                    <!-- Ширина линии -->
                                                    <CheckBox Grid.Row="13" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockLineWidth}"
                                                              ToolTip="Заблокировать ширину линии"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="13" 
                                                               Grid.Column="1"
                                                               Text="Ширина линии:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="13" 
                                                             Grid.Column="2"
                                                             Text="{Binding LineWidth, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionLineWidthTextBox_TextChanged"
                                                             IsEnabled="{Binding LockLineWidth, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Ширина линии (1-10)"
                                                             Margin="0,0,0,5"/>

                                                    <!-- Количество точек -->
                                                    <CheckBox Grid.Row="14" 
                                                              Grid.Column="0"
                                                              IsChecked="{Binding LockPointCount}"
                                                              ToolTip="Заблокировать количество точек"
                                                              VerticalAlignment="Center"
                                                              Content="🔒"
                                                              Margin="0,0,5,5"/>
                                                    <TextBlock Grid.Row="14" 
                                                               Grid.Column="1"
                                                               Text="Разрешение:"
                                                               VerticalAlignment="Center"
                                                               Margin="0,0,5,5"/>
                                                    <TextBox Grid.Row="14" 
                                                             Grid.Column="2"
                                                             Text="{Binding PointCount, UpdateSourceTrigger=PropertyChanged}"
                                                             TextChanged="FunctionPointCountTextBox_TextChanged"
                                                             IsEnabled="{Binding LockPointCount, Converter={StaticResource BooleanInverterConverter}}"
                                                             ToolTip="Количество точек для отрисовки (10-10000)"
                                                             Margin="0,0,0,5"/>
                                                                                </Grid>
                            </StackPanel>
                        </Expander.Content>
                    </Expander>
                </Grid>
            </Border>
        </DataTemplate>
    </ListBox.ItemTemplate>
</ListBox>
            </Border>
            
            </DockPanel>
        </Grid>
    </Grid>
</Window> 